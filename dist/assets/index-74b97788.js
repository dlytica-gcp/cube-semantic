import{j as e,c as B,S as I}from"./index-31f541c4.js";import{M as S}from"./index-166ce56c.js";import{A as k}from"./index-d4c68e4d.js";import{R as w,C as _,B as N}from"./index-2a334e56.js";import{u as H,F as P,S as v,I as b}from"./index-f28b3217.js";import{b as T}from"./index-74275833.js";import{v as C,c as z}from"./validations-55614028.js";import{S as L,Q as O,W as $,b as D,c as F,u as W,A as q,d as U}from"./alertTypes-bd9943c7.js";import{c as R}from"./capitalize-b2c18dd5.js";import{r as M}from"./react-venders-3a9fd7ec.js";import{u as A}from"./useTranslation-f1e31b7f.js";import{C as K,U as Q,V as G,W as J}from"./CurrentUserStore-886fe293.js";import{u as E}from"./useCheckResponse-471c00b7.js";const X="_space_wca5x_1",Y="_subtitle_wca5x_4",Z="_header_wca5x_10",V="_link_wca5x_13",ee="_alert_wca5x_17",se="_sendTest_wca5x_26",te="_saveBtn_wca5x_35",re="_deliveryInput_wca5x_38",o={space:X,subtitle:Y,header:Z,link:V,alert:ee,sendTest:se,saveBtn:te,deliveryInput:re},ae=({query:c,type:t="WEBHOOK",initialValue:s,onSubmit:l,onTest:m,onChangeStep:i,isSendTestLoading:d})=>{var g,p;const{t:r,i18n:{language:u}}=A(["reports","common"]),[f,x]=M.useState(0),{control:a,handleSubmit:n,watch:j}=H({values:s}),h=j("schedule");return M.useEffect(()=>{t&&x(1)},[t]),e.jsx(P,{layout:"vertical","data-testid":"report-form",children:e.jsxs(v,{className:B(o.space,o.body),size:16,children:[!s&&e.jsx("div",{className:o.header,children:e.jsx(L,{numbers:!1,steps:[r("common:words.reports"),r("common:words.new"),R(t)],onChange:i,currentStep:f})}),e.jsxs(w,{gutter:[16,16],children:[e.jsx(_,{span:24,md:12,children:e.jsx(b,{rules:{required:!0},label:r("form.report_name"),control:a,name:"name",placeholder:r("common:form.placeholders.name"),defaultValue:s==null?void 0:s.name})}),e.jsx(_,{span:24,md:12,children:e.jsx(b,{label:r("form.type"),control:a,name:"type",defaultValue:(s==null?void 0:s.type)||t,disabled:!0})})]}),e.jsxs(v,{direction:"vertical",className:o.space,children:[e.jsx("span",{className:o.subtitle,children:r("preview")}),e.jsx(O,{...c})]}),e.jsxs(w,{gutter:[16,16],align:"stretch",children:[e.jsx(_,{span:24,md:12,children:e.jsxs(v,{className:o.space,size:10,direction:"vertical",children:[e.jsx("span",{className:o.subtitle,children:r("delivery_settings")}),e.jsx("div",{className:o.deliveryInput,children:e.jsx(b,{starPosition:"left",starColor:"#A31BCB",label:`${R(t)}:`,control:a,rules:{required:!0,validate:t==="EMAIL"?y=>C.email(y)||r("common:form.errors.email"):y=>C.url(y)||r("common:form.errors.url")},placeholder:t==="EMAIL"?r("common:form.placeholders.email"):$,name:t==="EMAIL"?"deliveryConfig.address":"deliveryConfig.url",defaultValue:t==="EMAIL"?(g=s==null?void 0:s.deliveryConfig)==null?void 0:g.address:(p=s==null?void 0:s.deliveryConfig)==null?void 0:p.url})})]})}),e.jsx(_,{span:24,md:12,children:e.jsxs(v,{className:o.space,size:10,direction:"vertical",children:[e.jsx("span",{className:o.subtitle,children:r("trigger_settings")}),e.jsx("div",{className:o.deliveryInput,children:e.jsx(b,{rules:{required:!0,validate:C.cronExp},starPosition:"left",starColor:"#A31BCB",label:e.jsxs("span",{children:[r("schedule")," (",e.jsx("a",{className:o.link,href:"https://crontab.guru/",target:"_blank",rel:"noreferrer",children:r("build_cron_expression")}),"):"]}),control:a,name:"schedule",placeholder:"* * * * *",defaultValue:(s==null?void 0:s.schedule)||"* * * * *",suffix:e.jsx(T,{content:r("common:words.in_utc_timezone"),children:e.jsx(D,{})})})})]})})]}),e.jsx(k,{className:o.alert,message:e.jsxs(w,{justify:"space-between",align:"middle",children:[e.jsxs(_,{children:[e.jsx("span",{children:r("summary")}),":"," ",h&&C.cronExp(h)?z.toString(h,{locale:u,throwExceptionOnParseError:!1}):`${r("schedule_not_set")}, ${r("via")} ${R(t)}`]}),e.jsx(_,{children:e.jsxs(N,{className:o.sendTest,onClick:n(m),loading:d,disabled:d,children:[e.jsx(F,{})," ",r("common:words.send_test")]})})]}),type:"info"}),e.jsx(N,{className:o.saveBtn,type:"primary",size:"large",htmlType:"submit",form:"alert-form",onClick:n(l),children:r("common:words.save")})]})})},oe=({reportId:c,explorationId:t})=>{const{currentTeam:s}=K(),[l,m]=Q(),[i,d]=G(),[r,u]=J(),f=M.useCallback(a=>{const n={name:a.name,schedule:a.schedule,delivery_type:a.type,delivery_config:a.deliveryConfig,exploration_id:t,team_id:s==null?void 0:s.id};m({object:n})},[t,s==null?void 0:s.id,m]),x=M.useCallback(a=>{const n={name:a.name,schedule:a.schedule,delivery_type:a.type,delivery_config:a.deliveryConfig};d({pk_columns:{id:c},_set:n})},[d,c]);return{mutations:{createMutationData:l,execInsertMutation:m,updateMutationData:i,execUpdateMutation:d,deleteMutationData:r,execDeleteMutation:u},createReport:f,updateReport:x}},ce="_modal_pl24a_1",ne="_modalHeader_pl24a_4",de="_title_pl24a_10",le={modal:ce,modalHeader:ne,title:de},Ce=({exploration:c,report:t,isOpen:s,onClose:l,onChangeStep:m,onSelectDelivery:i,params:d={}})=>{const{t:r}=A(["reports","common"]),{delivery:u}=d,{createReport:f,updateReport:x,mutations:{createMutationData:a,updateMutationData:n}}=oe({reportId:t==null?void 0:t.id,explorationId:c==null?void 0:c.id}),{onSendTest:j,mutations:{sendTestMutationData:h}}=W({explorationId:c==null?void 0:c.id});E(a,()=>l(),{successMessage:r("reports:report_created")}),E(n,()=>l(),{successMessage:r("report_updated")}),E(h,()=>{},{successMessage:r("alerts:test_alert_sent")});const g=p=>{if(!!(t!=null&&t.id)){x(p);return}f(p)};return e.jsxs(S,{open:s,closable:!0,onClose:l,children:[e.jsx("div",{className:le.modalHeader}),t||u?e.jsx(I,{spinning:a.fetching||n.fetching,children:e.jsx(ae,{query:(c==null?void 0:c.playground_state)||{},onTest:j,onChangeStep:m,type:(t==null?void 0:t.type)||u,onSubmit:g,initialValue:t,isSendTestLoading:h.fetching})}):e.jsx(q,{type:"report",options:U,onSubmit:p=>i==null?void 0:i(p.value)})]})};export{Ce as R,oe as u};
