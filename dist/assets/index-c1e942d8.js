import{A as C}from"./index-d4c68e4d.js";import{E as m,S as D}from"./index-f28b3217.js";import{j as e,c as G,P as F}from"./index-31f541c4.js";import{u as J,r as b}from"./react-venders-3a9fd7ec.js";import{R as O,C as d,T as $}from"./index-2a334e56.js";import{f}from"./formatTime-900939d2.js";import{u as x}from"./useTranslation-f1e31b7f.js";import{T as z}from"./index-166ce56c.js";import{Q as B}from"./alertTypes-bd9943c7.js";import{C as A}from"./index-b892f6f0.js";import{T as L}from"./index-19cf5167.js";import{A as W}from"./index-c0d2be16.js";import{Q as H}from"./CurrentUserStore-886fe293.js";import"./button-255d95e9.js";import"./dayjs.min-e1e47a26.js";import"./index-d72c3122.js";import"./tslib.es6-5f87f175.js";import"./Sider-2eea88ce.js";import"./index-74275833.js";import"./index-17f232aa.js";import"./genName-6cc4e155.js";import"./validations-55614028.js";import"./capitalize-b2c18dd5.js";import"./useCheckResponse-471c00b7.js";import"./index-4e5c896b.js";import"./index-217cb9e2.js";import"./useLocation-795e9ebc.js";import"./paths-1d44e380.js";import"./AuthTokensStore-9401662d.js";import"./index-801816c4.js";import"./index-03282bf3.js";import"./index-e26e008e.js";import"./index-74b97788.js";import"./trash-colored-debd1411.js";import"./team-a9599a92.js";import"./urql.es-e4ed66a8.js";const U="_item_19ms2_1",V="_label_19ms2_8",X="_test_19ms2_11",l={item:U,label:V,test:X},Y=({request:s,queryKey:i})=>{const{t:r}=x(["logs"]);return e.jsxs(O,{gutter:[16,16],children:[e.jsx(d,{span:24,md:12,children:e.jsxs("div",{className:l.item,children:[e.jsxs("span",{className:l.label,children:[r("query.info.request_id"),":"]})," ",s.id]})}),e.jsx(d,{span:24,md:12,children:e.jsxs("div",{className:l.item,children:[e.jsxs("span",{className:l.label,children:[r("query.info.start_time"),":"]})," ",f(s.start_time)]})}),e.jsx(d,{span:24,md:12,children:e.jsxs("div",{className:l.item,children:[e.jsxs("span",{className:l.label,children:[r("query.info.path"),":"]})," ",s.path]})}),e.jsx(d,{span:24,md:12,children:e.jsxs("div",{className:l.item,children:[e.jsxs("span",{className:l.label,children:[r("query.info.end_time"),":"]})," ",f(s.end_time)]})}),e.jsx(d,{span:24,md:12,children:e.jsxs("div",{className:l.item,children:[e.jsxs("span",{className:l.label,children:[r("query.info.duration"),":"]})," ",s.duration]})}),e.jsx(d,{span:24,md:12,children:e.jsxs("div",{className:l.item,children:[e.jsxs("span",{className:l.label,children:[r("query.info.query_key_md5"),":"]})," ",i]})})]})},Z="_table_137ig_1",ee="_cell_137ig_7",se="_timestamp_137ig_11",c={table:Z,cell:ee,timestamp:se},te=({events:s})=>{const{t:i}=x(["logs"]),r=[{title:i("query.table.event"),dataIndex:"event",key:"event",render:t=>e.jsx("span",{className:c.cell,children:t})},{title:i("query.table.duration"),dataIndex:"duration",key:"duration",render:t=>e.jsx("span",{className:c.cell,children:t})},{title:i("query.table.time_in_queue"),dataIndex:"time_in_queue",key:"time_in_queue",render:t=>e.jsx("span",{className:c.cell,children:t||0})},{title:e.jsx("div",{className:c.timestamp,children:i("query.table.timestamp")}),dataIndex:"timestamp",key:"timestamp",render:t=>e.jsx("div",{className:G(c.cell,c.timestamp),children:f(t)})}];return e.jsx(L,{className:c.table,columns:r,dataSource:s,rowKey:t=>t.id,pagination:!1})},ae="_btn_yp68x_1",_={btn:ae},{Title:u}=$,ie=({query:s,SQLString:i,events:r})=>{const{t}=x(["logs"]),o=[{label:e.jsx("span",{className:_.btn,children:t("query.details.query_key")}),key:"1",children:s?e.jsxs(e.Fragment,{children:[e.jsx(u,{level:5,children:t("query.details.query_key")}),e.jsx(B,{measures:s==null?void 0:s.measures,dimensions:s==null?void 0:s.dimensions,segments:s==null?void 0:s.segments,timeDimensions:s==null?void 0:s.timeDimensions,order:s==null?void 0:s.order,withButton:!1},"queryKey")]}):e.jsx(m,{image:m.PRESENTED_IMAGE_SIMPLE})},{label:e.jsx("span",{className:_.btn,children:t("query.details.sql")}),key:"2",children:i?e.jsxs(e.Fragment,{children:[e.jsx(u,{level:5,children:t("query.details.sql")}),e.jsx(A,{value:i},"sql")]}):e.jsx(m,{image:m.PRESENTED_IMAGE_SIMPLE})},{label:e.jsx("span",{className:_.btn,children:t("query.details.query")}),key:"3",children:s?e.jsxs(e.Fragment,{children:[e.jsx(u,{level:5,children:t("query.details.query")}),e.jsx(A,{value:JSON.stringify(s,null,2)},"query")]}):e.jsx(m,{image:m.PRESENTED_IMAGE_SIMPLE})},{label:e.jsx("span",{className:_.btn,children:t("query.table.events")}),key:"4",children:r?e.jsxs(e.Fragment,{children:[e.jsx(u,{level:5,children:t("query.table.events")}),e.jsx(te,{events:r})]}):e.jsx(m,{image:m.PRESENTED_IMAGE_SIMPLE})}];return e.jsx(z,{defaultActiveKey:"1",items:o})},re="_wrapper_w3n8e_1",ne="_body_w3n8e_4",le="_action_w3n8e_8",me="_actionIcon_w3n8e_12",R={wrapper:re,body:ne,action:le,actionIcon:me},oe=({error:s,request:i,fetching:r,query:t,SQLString:o,queryKey:y,events:j})=>{const{t:h}=x(["logs","pages","common"]);return i!=null&&i.request_id?e.jsx(W,{divider:!0,title:h("pages:logs.query"),children:e.jsx(D,{className:R.wrapper,direction:"vertical",size:13,children:e.jsxs(D,{className:R.body,size:13,direction:"vertical",children:[s&&e.jsx(C,{message:s,type:"error"}),e.jsx(Y,{request:i,queryKey:y}),e.jsx(ie,{query:t,SQLString:o,events:j})]})})}):e.jsx(F,{spinning:r,children:e.jsx(m,{image:m.PRESENTED_IMAGE_SIMPLE})})},Le=()=>{var E;const{id:s}=J(),[i,r]=H({variables:{id:s},pause:!0,requestPolicy:"cache-and-network"});b.useEffect(()=>{s&&r()},[s,r]);const t=b.useMemo(()=>{var a;return((a=i.data)==null?void 0:a.request_logs_by_pk)||{}},[i]),{events:o,querySql:y,queryKeyMd5:j,error:h}=b.useMemo(()=>{var g,q,v,k,I,S;let a=(t==null?void 0:t.request_event_logs)||[];a=a.map((n,T)=>{var M,w;const P=(M=a==null?void 0:a[T])==null?void 0:M.timestamp,Q=((w=a==null?void 0:a[T+1])==null?void 0:w.timestamp)||P,K=Date.parse(P)-Date.parse(Q);return{...n,duration:K}});let p=(q=(g=t==null?void 0:t.request_event_logs)==null?void 0:g.find(n=>n.query_key))==null?void 0:q.query_key;if(p)try{p=JSON.parse(p)}catch(n){console.error(n)}return{events:a,error:(v=a==null?void 0:a.find(n=>n==null?void 0:n.error))==null?void 0:v.error,querySql:(k=a==null?void 0:a.find(n=>n==null?void 0:n.query_sql))==null?void 0:k.query_sql,queryKey:p,queryKeyMd5:(S=(I=t==null?void 0:t.request_event_logs)==null?void 0:I.find(n=>n.query_key_md5))==null?void 0:S.query_key_md5}},[t.request_event_logs]),N=(E=o==null?void 0:o.find(a=>a==null?void 0:a.query))==null?void 0:E.query;return e.jsx(oe,{request:t,SQLString:y,events:o,queryKey:j,query:N&&JSON.parse(N),fetching:i.fetching,error:h})};export{oe as QueryDetailed,Le as default};
