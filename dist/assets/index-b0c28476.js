import{R as z,C as N,B as L,T as W}from"./index-2a334e56.js";import{D as K}from"./index-17f232aa.js";import{u as X,F as Z,I as M,S as V}from"./index-f28b3217.js";import{j as s,c as P,S as ss}from"./index-31f541c4.js";import{m as $}from"./index-4e5c896b.js";import{r as T,u as es}from"./react-venders-3a9fd7ec.js";import{u as D}from"./index-d72c3122.js";import{C as G,J as os,M as ts}from"./CurrentUserStore-886fe293.js";import{C as B,g as J}from"./genName-6cc4e155.js";import{u as U}from"./useTranslation-f1e31b7f.js";import{M as ns,a as rs}from"./index-166ce56c.js";import{P as cs}from"./index-0f090c4c.js";import{u as O}from"./useCheckResponse-471c00b7.js";import{u as as}from"./useLocation-795e9ebc.js";import{f as Q}from"./formatTime-900939d2.js";import{D as ds}from"./index-d5b304fb.js";import{C as ls}from"./index-81782579.js";import{f as ms}from"./paths-1d44e380.js";import{S as is}from"./SettingOutlined-58db4ea1.js";const ps="_text_5as4z_1",_s="_label_5as4z_4",us="_radio_5as4z_7",xs="_icon_5as4z_11",bs="_textareaWrapper_5as4z_15",hs="_textareaCopy_5as4z_18",fs="_back_5as4z_23",gs="_submit_5as4z_29",js="_fullwidth_5as4z_33",ws="_link_5as4z_39",ys="_skip_5as4z_48",Ss="_cetner_5as4z_51",i={text:ps,label:_s,radio:us,icon:xs,textareaWrapper:bs,textareaCopy:hs,back:fs,submit:gs,fullwidth:js,link:ws,skip:ys,cetner:Ss},{Title:Cs,Text:ks}=W,q="psql",qs=window.CUBEJS_MYSQL_API_URL!==void 0?window.CUBEJS_MYSQL_API_URL:"tcp://sql-api.synmetrix.org:13306",Ts=window.CUBEJS_PG_API_URL!==void 0?window.CUBEJS_PG_API_URL:"tcp://sql-api.synmetrix.org:15432",E={mysql:qs,psql:Ts},vs=[{value:"psql",label:"PSQL",disabled:!1,name:"connection"},{value:"mysql",label:"MySQL",disabled:!1,name:"connection"}],Ms=[{label:"Host/URL",value:"host",name:"host",disabled:!0},{label:"Database",value:"db",name:"db",disabled:!0},{label:"Login (auto-generated)",name:"db_username"},{label:"Password (auto-generated)",type:"password",name:"password"}],Ps=({connectionOptions:a=vs,initialValue:e,isOnboarding:o,isNew:p,onSubmit:x,onGoBack:h})=>{const{teamData:l}=G(),{control:_,handleSubmit:v,setValue:f,getValues:y,watch:c,resetField:S}=X({values:e}),{t:u}=U(["apiSetup","common"]),C=D(),t=n=>u(`common:form.labels.${n}`,n),g=T.useCallback(({connection:n=q,host:d=E[q],user:r=e==null?void 0:e.db_username,password:m=e==null?void 0:e.password,database:j=e==null?void 0:e.db})=>{const[w,b]=d.split(":"),A=b?`-P ${b}`:"",H=b?`--port=${b}`:"";return n==="mysql"?`mysql -u ${r} -p -h ${w} ${A} -D ${j}`:`psql --host=${w} ${H} --username=${r} --dbname=${j}`},[e==null?void 0:e.password,e==null?void 0:e.db_username,e==null?void 0:e.db]),k=()=>{const n=y();delete n.datasource_id,delete n.user_id;const d="data:text/json;charset=utf-8,"+encodeURIComponent(JSON.stringify(n,null,2)),r=document.createElement("a");r.href=d,r.download="credentials.json",r.click(),r.remove()};return T.useEffect(()=>{const n=c((d,{name:r})=>{if(["password","db_username","connection"].includes(r||"")){const m={user:d.db_username,password:d.password,host:E[d.connection||q],connection:d.connection};S("host",{defaultValue:m.host}),S("connection_string",{defaultValue:g(m)})}});return()=>n.unsubscribe()},[g,S,f,c]),s.jsxs("div",{children:[s.jsx(Cs,{level:3,style:{marginTop:0},children:u("title")}),s.jsx(ks,{children:u("text")}),s.jsxs(Z,{layout:"vertical",id:"api-setup",children:[s.jsxs(z,{gutter:[16,16],children:[s.jsx(N,{xs:24,sm:12,children:s.jsx(M,{control:_,name:"user_id",fieldType:"select",label:t("team_member"),defaultValue:e==null?void 0:e.user_id,options:((l==null?void 0:l.members)||[]).map(n=>({value:n.user_id,label:n.displayName})),disabled:!o||!p})}),s.jsx(N,{xs:24,sm:12,children:s.jsx(M,{className:i.input,control:_,name:"datasource_id",fieldType:"select",label:t("data_source"),defaultValue:e==null?void 0:e.datasource_id,options:((l==null?void 0:l.dataSources)||[]).map(n=>({value:n.id,label:n.name})),disabled:!o||!p})})]}),s.jsx(M,{control:_,name:"connection",label:t("connect_via"),size:"large",optionType:"button",options:a,defaultValue:q,fieldType:"radio"}),s.jsx(z,{gutter:[16,16],children:Ms.map(n=>{const d=n.name;return s.jsx(N,{xs:24,sm:12,children:s.jsx(M,{control:_,name:d,defaultValue:e==null?void 0:e[d],fieldType:n.type,label:n.label,disabled:n.disabled||!o||!p,suffix:s.jsx(B,{className:i.icon,onClick:()=>navigator.clipboard.writeText(y(d)||"")})})},n.label)})}),s.jsxs("div",{className:P(i.textareaWrapper,i.label),children:[s.jsx(M,{control:_,defaultValue:g({}),name:"connection_string",fieldType:"textarea",label:`${t("connect_using")} ${c("connection")||q}-client`,disabled:!0}),s.jsx(B,{className:P(i.icon,i.textareaCopy),onClick:()=>navigator.clipboard.writeText(y("connection_string")||"")})]}),s.jsx(z,{align:"middle",justify:"space-between",children:s.jsxs(N,{xs:24,md:18,children:[!o&&s.jsx(L,{className:P(i.back,{[i.fullwidth]:!C.md}),size:"large",color:"primary",onClick:h,children:u("common:words.back")}),s.jsx(L,{className:P(i.submit,{[i.fullwidth]:!C.md}),type:"primary",size:"large",htmlType:"submit",form:"api-setup",onClick:v(x),children:u(o?"common:words.finish":"common:words.close")}),s.jsx(L,{className:P(i.link,{[i.fullwidth]:!C.md}),type:"link",onClick:k,children:u("common:words.download_credentials")})]})})]})]})},Ns="/assets/no-credentials-e57c1a9d.png",$s="_wrapper_1f9ck_1",zs="_img_1f9ck_11",Ls="_text_1f9ck_14",Us="_btn_1f9ck_17",I={wrapper:$s,img:zs,text:Ls,btn:Us},{Title:As,Text:Is}=W,Rs=({editPermission:a,onAttach:e=()=>{}})=>{const{t:o}=U(["settings","common"]);return s.jsxs("div",{className:I.wrapper,children:[s.jsx("img",{className:I.img,src:Ns,alt:""}),s.jsx(As,{level:4,children:o("sql_api.not_found.title")}),s.jsx(Is,{className:I.text,children:o("sql_api.not_found.text")}),a&&s.jsx(L,{size:"large",type:"primary",onClick:e,children:o("sql_api.not_found.attach_btn")})]})},Es="_wrapper_6f3tq_1",Fs="_body_6f3tq_4",R={wrapper:Es,body:Fs},Y=({editPermission:a,credentials:e=[],initialValue:o,isNew:p,editId:x,loading:h=!1,onEdit:l=()=>{},onRemove:_=()=>{},onFinish:v=()=>{},onOpen:f=()=>{},onClose:y=()=>{}})=>{const{t:c}=U(["settings","pages"]),S=D(),u=a&&e.length?c("settings:sql_api.action"):null,C=t=>{var g;return s.jsx(ls,{title:t.dataSourceData.name,titleTooltip:t.dataSourceData.name,onTitleClick:()=>t.id&&l(t.id),extra:s.jsx(K,{className:R.btn,trigger:["click"],menu:{items:[{key:"edit",label:c("common:words.edit"),onClick:()=>t.id&&l(t.id)},{key:"delete",label:s.jsx(rs,{title:c("common:words.delete_sqlapi"),onConfirm:()=>t.id&&_(t.id),children:c("common:words.delete")})}]},children:s.jsx(is,{},"setting")}),children:s.jsxs("dl",{children:[t.dataSourceData.dbParams.host&&s.jsxs(s.Fragment,{children:[s.jsx("dt",{children:c("common:words.host")}),s.jsx("dd",{title:t.dataSourceData.dbParams.host,children:t.dataSourceData.dbParams.host})]}),t.dataSourceData.type&&s.jsxs(s.Fragment,{children:[s.jsx("dt",{children:c("common:words.type")}),s.jsx("dd",{children:s.jsx(ds,{dataSource:t.dataSourceData.type})})]}),((g=t.member)==null?void 0:g.displayName)&&s.jsxs(s.Fragment,{children:[s.jsx("dt",{children:c("common:words.member")}),s.jsx("dd",{title:t.login,children:t.member.displayName})]}),t.login&&s.jsxs(s.Fragment,{children:[s.jsx("dt",{children:c("common:words.login")}),s.jsx("dd",{title:t.login,children:t.login})]}),t.createdAt&&s.jsxs(s.Fragment,{children:[s.jsx("dt",{children:c("common:words.created_at")}),s.jsx("dd",{title:Q(t.createdAt),children:Q(t.createdAt)})]})]})},t.id)};return s.jsxs(s.Fragment,{children:[s.jsx(ss,{spinning:h,children:s.jsxs(V,{className:R.wrapper,direction:"vertical",size:13,children:[s.jsx(cs,{title:S.sm?c("settings:sql_api.title"):c("settings:sql_api.title_mobile"),action:u,actionProps:{type:"primary",size:"large"},onClick:f}),s.jsx("div",{className:R.body,children:e!=null&&e.length?s.jsx(z,{gutter:[32,32],children:e.map(t=>s.jsx(N,{xs:24,sm:12,xl:8,children:C(t)},t.id))}):s.jsx(Rs,{editPermission:a,onAttach:f})})]})}),s.jsx(ns,{width:1e3,open:!!x,onClose:y,closable:!0,children:s.jsx(Ps,{isNew:p,isOnboarding:!!x,initialValue:o,onSubmit:v})})]})},F=(a,e,o,p)=>({user_id:e,datasource_id:a,name:o,host:E[q],db:"db",db_username:p||J(10),password:J(10)}),Bs=()=>{const{t:a}=U(["apiSetup","pages"]),{currentTeam:e,teamData:o}=G(),[,p]=as(),{editId:x}=es(),h=x==="new",l=ms,[_,v]=os(),[f,y]=ts(),c=()=>{p(l)};O(_,(r,m)=>{var j,w;if((j=r==null?void 0:r.insert_sql_credentials_one)!=null&&j.id){$.success(a("apiSetup:sql_credentials_created")),c();return}m&&((w=m==null?void 0:m.message)!=null&&w.includes("Uniqueness violation")?$.error(a("apiSetup:uniq_violation")):$.error(m))},{showMessage:!1,showResponseMessage:!1}),O(f,()=>{},{successMessage:a("apiSetup:sql_credentials_deleted")});const S=r=>{y({id:r})},u=r=>{p(`${l}/${r}`)},C=()=>{p(`${l}/new`)},t=r=>{h?v({object:{user_id:r.user_id,datasource_id:r.datasource_id,username:r.db_username,password:r.password}}):c()},g=T.useMemo(()=>_.fetching||f.fetching,[_.fetching,f.fetching]),k=T.useMemo(()=>(o==null?void 0:o.sqlCredentials)||[],[o==null?void 0:o.sqlCredentials]),n=T.useMemo(()=>(o==null?void 0:o.dataSources)||[],[o==null?void 0:o.dataSources]),d=T.useMemo(()=>{var r,m,j,w;if(!h&&x&&k.length){const b=k.find(A=>A.id===x);if(b)return F(b.dataSourceData.id,b.member.userId,b.dataSourceData.name,b.login);$.warning(a("apiSetup:not_found"))}return F((r=n==null?void 0:n[0])==null?void 0:r.id,(j=(m=o==null?void 0:o.members)==null?void 0:m[0])==null?void 0:j.user_id,(w=n==null?void 0:n[0])==null?void 0:w.name)},[k,h,x,o==null?void 0:o.members,n,a]);return s.jsx(Y,{loading:g,isNew:h,editId:x,editPermission:(e==null?void 0:e.role)!=="member",teamMembers:o==null?void 0:o.members,dataSources:n,credentials:k,initialValue:d,onEdit:u,onRemove:S,onFinish:t,onOpen:C,onClose:c})},ae=Object.freeze(Object.defineProperty({__proto__:null,SqlApi:Y,default:Bs,prepareInitValues:F},Symbol.toStringTag,{value:"Module"}));export{Ps as A,ae as i,F as p};
