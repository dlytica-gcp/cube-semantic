import{C as ve}from"./index-166ce56c.js";import{j as n,c as G,S as Me}from"./index-31f541c4.js";import{r as g}from"./react-venders-3a9fd7ec.js";import{F as Ne,S as Te}from"./alertTypes-bd9943c7.js";import{R as Z,C as P,B as R,T as xe}from"./index-2a334e56.js";import{u as we}from"./index-d72c3122.js";import{u as Ce,f as Fe}from"./index-c0d2be16.js";import{S as Ie,D as $e}from"./index-b094a404.js";import{u as Y}from"./useTranslation-f1e31b7f.js";import{A as Ee}from"./index-d4c68e4d.js";import{u as Ae,F as Ge,I as le}from"./index-f28b3217.js";import{A as Be,p as Oe}from"./index-b0c28476.js";import{a as de,d as me}from"./dataSources-efcbf825.js";import{m as ue}from"./index-4e5c896b.js";import{C as qe,J as De,j as Le,g as We,h as Re,k as Pe,n as Ue,K as ze}from"./CurrentUserStore-886fe293.js";import{c as He}from"./index-801816c4.js";import{u as W}from"./useCheckResponse-471c00b7.js";const Ke="_bouncingDots_1wwkz_1",Qe="_dot_1wwkz_6",Je="_bounce_1wwkz_1",Q={bouncingDots:Ke,dot:Qe,bounce:Je},Ze=({loading:s,children:e})=>n.jsx(n.Fragment,{children:s?n.jsxs("div",{className:Q.bouncingDots,children:[n.jsx("div",{className:Q.dot}),n.jsx("div",{className:Q.dot}),n.jsx("div",{className:Q.dot})]}):e}),Xe="_tiles_1c835_1",Ye="_submit_1c835_4",Ve="_fullwidth_1c835_8",Se="_link_1c835_13",es="_skip_1c835_22",ss="_cetner_1c835_25",ts="_tilesWrapper_1c835_28",F={tiles:Xe,submit:Ye,fullwidth:Ve,link:Se,skip:es,cetner:ss,tilesWrapper:ts},{Title:pe,Text:ns}=xe,rs=103,J=8*2,is=rs+J,he=({options:s,initialValue:e,onSkip:r,onSubmit:i})=>{const{t:c}=Y(["dataSourceSelecton","common"]),x=we(),w=(x==null?void 0:x.md)!==!0,[f,k]=g.useState(),d=Ce(f),[p,j]=g.useState(""),M=g.useMemo(()=>{if(d!=null&&d.width){const a=Math.floor((d.width+2)/is),y=(a-1)*J,t=((d==null?void 0:d.width)-2-y)/a;return Math.floor(t)}},[d==null?void 0:d.width]);return n.jsxs("div",{className:F.wrapper,children:[n.jsx(pe,{level:3,style:{marginTop:0},children:c("title")}),n.jsx(ns,{children:c("text")}),n.jsx(pe,{level:5,children:c("subtitle")}),n.jsx(Ie,{value:p,onChange:j,placeholder:c("search_placeholder")}),n.jsx("div",{className:F.tilesWrapper,ref:a=>k(a),children:n.jsx(Z,{className:F.tiles,gutter:[J,J],justify:"start",children:s.filter(a=>{var y;return(y=a.name)==null?void 0:y.toLowerCase().includes(p.toLowerCase())}).map(a=>n.jsx(P,{className:F.tile,children:n.jsx(Ne,{width:M,title:a.name||"",icon:a.icon,active:(e==null?void 0:e.value)===a.value,onClick:()=>i==null?void 0:i(a)})},a.name))})}),n.jsx(Z,{align:"middle",justify:"end",children:!!r&&n.jsx(P,{xs:24,md:6,className:G(F.skip,{[F.center]:w}),children:n.jsx(R,{className:G(F.link,{[F.fullwidth]:w}),type:"link",onClick:r,children:c("common:words.skip")})})})]})},cs="_head_17ojd_1",os="_dataSource_17ojd_4",as="_iconWrapper_17ojd_9",ls="_title_17ojd_26",ds="_text_17ojd_32",ms="_form_17ojd_36",us="_back_17ojd_45",ps="_submit_17ojd_51",hs="_fullwidth_17ojd_55",_s="_link_17ojd_61",fs="_skip_17ojd_70",js="_cetner_17ojd_73",xs="_error_17ojd_76",h={head:cs,dataSource:os,iconWrapper:as,title:ls,text:ds,form:ms,back:us,submit:ps,fullwidth:hs,link:_s,skip:fs,cetner:js,error:xs},{Title:ws,Text:ys}=xe,bs=({loading:s=!1,dataSource:e,fields:r,onSubmit:i,onGoBack:c,onSkip:x,onTestConnection:w,initialValue:f,isOnboarding:k=!1})=>{const{t:d}=Y(["dataSetupForm","common"]),[p]=g.useState(!1),j=we(),{control:M,handleSubmit:a}=Ae({values:f}),y=m=>d(`common:form.labels.${m}`,m),t=m=>m?d(`common:form.placeholders.${m}`,m):"";return n.jsxs("div",{className:h.wrapper,children:[n.jsxs("div",{className:h.head,children:[n.jsxs("div",{className:h.dataSource,children:[n.jsx("div",{className:h.iconWrapper,children:e.icon}),n.jsx(ws,{className:h.title,level:3,children:e.name})]}),n.jsxs(ys,{className:h.text,children:[d("text.line1")," ",n.jsx("br",{})," ",d("text.line2")]})]}),n.jsx(Me,{spinning:s,children:n.jsxs(Ge,{className:h.form,id:"setup-form",layout:"vertical",children:[n.jsx(le,{rules:{required:!0},control:M,name:"name",label:y("name"),placeholder:t("name"),defaultValue:f==null?void 0:f.name}),n.jsx(Z,{gutter:16,children:r.map(m=>{var $;const I=m.name.split(".")[1],T=($=f==null?void 0:f.db_params)==null?void 0:$[I];return n.jsx(P,{xs:24,sm:12,children:n.jsx(le,{rules:m.rules,control:M,fieldType:m.type,name:`db_params.${I}`,placeholder:t(m.placeholder),label:y(m.label),defaultValue:T})},m.name)})}),n.jsxs(Z,{align:"middle",justify:"space-between",children:[n.jsxs(P,{xs:24,md:18,children:[k&&n.jsx(R,{className:G(h.back,{[h.fullwidth]:!j.md}),size:"large",color:"primary",onClick:c,children:d("common:words.back")}),n.jsx(R,{className:G(h.submit,{[h.fullwidth]:!j.md}),form:"setup-form",type:"primary",size:"large",htmlType:"submit",onClick:a(i),children:d(k?"common:words.apply":"common:words.save")}),n.jsx(R,{className:G(h.link,{[h.fullwidth]:!j.md}),type:"link",onClick:a(m=>w(m,!0)),children:d("common:words.test_connection")})]}),!!x&&n.jsx(P,{xs:24,md:6,className:G(h.skip,{[h.center]:!j.md}),children:n.jsx(R,{className:G(h.link,{[h.fullwidth]:!j.md}),type:"link",onClick:x,children:d("common:words.skip")})})]})]})}),p&&n.jsx(Ee,{message:n.jsx("span",{className:h.error,children:"Error"}),type:"error"})]})},ye={step0:void 0,step1:void 0,step2:void 0,step3:void 0},_e={step:0,branchId:void 0,isOnboarding:!1,isGenerate:!1,formState:ye,schema:void 0},X=He(s=>({..._e,setIsGenerate:e=>s(r=>({...r,isGenerate:e})),setSchema:e=>s(r=>({...r,schema:e})),setEditId:e=>s(r=>({...r,id:e})),setFormStateData:(e,r,i)=>s(c=>{const x=`step${e}`;return{...c,formState:{...c.formState,[x]:r},...i}}),setStep:e=>s(r=>({...r,step:e})),nextStep:()=>s(e=>({...e,step:((e==null?void 0:e.step)||0)+1})),setIsOnboarding:e=>s(r=>({...r,isOnboarding:e})),clean:()=>s({..._e})})),gs=({activeStep:s,formState:e,loading:r=!1,onSkip:i,onChangeStep:c,onFinish:x=()=>{},onTestConnection:w=()=>{},onDataSourceSetupSubmit:f=()=>{},onDataModelGenerationSubmit:k=()=>{},onDataSourceSelect:d=()=>{}})=>{const{step:p,isOnboarding:j,isGenerate:M,formState:a,schema:y,setStep:t}=X(),m=()=>(c==null?void 0:c(p-1))||t(p-1),I=()=>(c==null?void 0:c(p+1))||t(p+1),T=async C=>{await f(C)},$=async C=>{await k(C)};g.useEffect(()=>{s&&t(s)},[s,t]);const _=(e==null?void 0:e.step0)||(a==null?void 0:a.step0);switch(p){case 0:return n.jsx(he,{onSkip:i,onSubmit:d,initialValue:_,options:me});case 1:if(_){const E=(e==null?void 0:e.step1)||(a==null?void 0:a.step1);return n.jsx(bs,{dataSource:_,fields:de[Object.keys(de).find(z=>z===(_==null?void 0:_.value))??"default"],loading:r,isOnboarding:j,initialValue:E,onSubmit:T,onSkip:i,onGoBack:m,onTestConnection:w})}case 2:return n.jsx($e,{dataSource:{icon:_==null?void 0:_.icon,name:_==null?void 0:_.name},isGenerate:M,isOnboarding:j,schema:y,onSubmit:$,onGoBack:m,onSkip:i||I,loading:r,initialValue:(e==null?void 0:e.step2)||(a==null?void 0:a.step2)||{}});case 3:const C=(e==null?void 0:e.step3)||(a==null?void 0:a.step3);return n.jsx(Be,{isOnboarding:j,initialValue:C,onSubmit:x,onGoBack:m})}return n.jsx(he,{onSubmit:d,initialValue:_,options:me,onSkip:i})},ks="_header_1ppv1_1",vs={header:ks},zs=({onFinish:s=()=>{},onDataSourceSelect:e=()=>{},onTestConnection:r=()=>{},onDataSourceSetupSubmit:i=()=>{},onDataModelGenerationSubmit:c=()=>{},onSkip:x,onChangeStep:w,bordered:f=!0,loading:k=!1,shadow:d=!0})=>{const{t:p}=Y(["dataSourceStepForm"]),{step:j}=X();return n.jsxs(ve,{style:{boxShadow:d===!1?"0 0 0 0":void 0},bordered:f,children:[w&&n.jsx("div",{className:vs.header,children:n.jsx(Te,{currentStep:j,steps:[p("step1"),p("step2"),p("step3"),p("step4")],onChange:w})}),n.jsx(g.Suspense,{fallback:n.jsx(Ze,{}),children:n.jsx(gs,{loading:k,onSkip:x,onFinish:s,onChangeStep:w,onDataSourceSelect:e,onTestConnection:r,onDataSourceSetupSubmit:i,onDataModelGenerationSubmit:c})})]})};var fe=Object.prototype.hasOwnProperty;function je(s,e,r){for(r of s.keys())if(U(r,e))return r}function U(s,e){var r,i,c;if(s===e)return!0;if(s&&e&&(r=s.constructor)===e.constructor){if(r===Date)return s.getTime()===e.getTime();if(r===RegExp)return s.toString()===e.toString();if(r===Array){if((i=s.length)===e.length)for(;i--&&U(s[i],e[i]););return i===-1}if(r===Set){if(s.size!==e.size)return!1;for(i of s)if(c=i,c&&typeof c=="object"&&(c=je(e,c),!c)||!e.has(c))return!1;return!0}if(r===Map){if(s.size!==e.size)return!1;for(i of s)if(c=i[0],c&&typeof c=="object"&&(c=je(e,c),!c)||!U(i[1],e.get(c)))return!1;return!0}if(r===ArrayBuffer)s=new Uint8Array(s),e=new Uint8Array(e);else if(r===DataView){if((i=s.byteLength)===e.byteLength)for(;i--&&s.getInt8(i)===e.getInt8(i););return i===-1}if(ArrayBuffer.isView(s)){if((i=s.byteLength)===e.byteLength)for(;i--&&s[i]===e[i];);return i===-1}if(!r||typeof s=="object"){i=0;for(r in s)if(fe.call(s,r)&&++i&&!fe.call(e,r)||!(r in e)||!U(s[r],e[r]))return!1;return Object.keys(e).length===i}}return s!==s&&e!==e}const Hs=({editId:s})=>{const{t:e}=Y(["dataSourceStepForm"]),{currentTeam:r,teamData:i,currentUser:c}=qe(),[,x]=De(),[w,f]=Le(),[k,d]=We(),[p,j]=Re(),[M,a]=Pe(),{formState:{step0:y,step1:t},branchId:m,schema:I,step:T,clean:$,setSchema:_,setFormStateData:C}=X(),[E,z]=Ue({variables:{id:t==null?void 0:t.id},pause:!0});W(k,()=>{},{successMessage:e("datasource_created")}),W(p,()=>{},{successMessage:e("datasource_updated")}),W(E,()=>{},{showMessage:!1}),W(M,()=>{},{successMessage:e("schema_generated")}),W(w,()=>{},{successMessage:e("connection_ok")});const q=g.useMemo(()=>(i==null?void 0:i.dataSources)||[],[i]),N=g.useMemo(()=>q.find(o=>o.id===s||o.id===(t==null?void 0:t.id)),[s,t==null?void 0:t.id,q]),be=async o=>{let l={...o};if(delete l.type,l=Object.values(l).reduce((u,b)=>[...u,...Object.keys(b).map(A=>({name:A}))],[]),t&&!m){ue.error(`${e("no_branch")} ${t.name}`);return}if(t)return(await a({datasource_id:t.id,branch_id:m,tables:l,format:(o==null?void 0:o.type)||"yaml",overwrite:!0})).error?null:!0},V=(o,l)=>{const u=Oe(l,c.id,o),b={user_id:c.id,username:u.db_username,password:u.password};return l&&(b.datasource_id=l),{apiConfig:u,credentialParams:b}},S=async(o,l,u=5)=>{var L;if(u===0)return!1;const{apiConfig:b,credentialParams:A}=V(l,o),D=await x({object:A}),H=(L=D.data)==null?void 0:L.insert_sql_credentials_one;return D.error||!H?await S(o,l,u-1):b},ee=async o=>{var b,A,D,H,L,te,ne,re,ie,ce,oe,ae;let l,u;if(t!=null&&t.id){delete o.id;const K={pk_columns:{id:t==null?void 0:t.id},_set:o},v=await j(K);l=(re=(ne=v==null?void 0:v.data)==null?void 0:ne.update_datasources_by_pk)==null?void 0:re.id,u=(ae=(oe=(ce=(ie=v==null?void 0:v.data)==null?void 0:ie.update_datasources_by_pk)==null?void 0:ce.branches)==null?void 0:oe[0])==null?void 0:ae.id}else{const K={...o,db_type:(b=y==null?void 0:y.value)==null?void 0:b.toUpperCase()};r!=null&&r.id&&(K.team_id=r==null?void 0:r.id);let{apiConfig:v,credentialParams:ke}=V(o.name);const B=await d({object:{...K,branches:{data:[{status:ze.Active,user_id:c.id}]},sql_credentials:{data:[ke]}}}),O=(A=B==null?void 0:B.data)==null?void 0:A.insert_datasources_one;if(l=O==null?void 0:O.id,u=(D=O==null?void 0:O.branches[0])==null?void 0:D.id,!!!((te=(L=(H=B==null?void 0:B.data)==null?void 0:H.insert_datasources_one)==null?void 0:L.sql_credentials)!=null&&te[0])&&(v=await S(l,o.name),!v)){ue.error(`${e("sql_credentials_error")} ${o.name}`);return}C(3,{...v,datasource_id:l})}if(l)return C(1,{...o,id:l},{branchId:u}),l},se=async o=>{var u;return(u=(await f({id:(t==null?void 0:t.id)||(o==null?void 0:o.id)})).data)!=null&&u.check_connection?!0:null},ge=async(o,l,u)=>{let b=t==null?void 0:t.id;(!(t!=null&&t.id)||!U({...o},{...t}))&&(b=await ee(o)),!(!await se({id:b})||l)&&(u==null||u())};return g.useEffect(()=>{if(N){const{currentBranch:o}=Fe(q,s||(t==null?void 0:t.id));X.setState(l=>({...l,formState:{...ye,...l.formState,step0:N.type,step1:{id:N==null?void 0:N.id,db_params:{...N.dbParams},name:N.name,...l.formState.step1}},branchId:o.id}))}},[N,t==null?void 0:t.id,q,s]),g.useEffect(()=>{T===2&&(t!=null&&t.id)&&!I&&z()},[t==null?void 0:t.id,I,T,z]),g.useEffect(()=>{var o,l;E.data&&_((l=(o=E.data)==null?void 0:o.fetch_tables)==null?void 0:l.schema)},[E.data,_]),g.useEffect(()=>{T===0&&$()},[$,T]),{loading:k.fetching||w.fetching||p.fetching||M.fetching||E.fetching,dataSources:q,curDataSource:N,onTestConnection:se,createOrUpdateDataSource:ee,onDataModelGenerationSubmit:be,onDataSourceSetupSubmit:ge}};export{zs as D,X as d,Hs as u};
