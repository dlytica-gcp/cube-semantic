import{j as S}from"./index-31f541c4.js";import{C as D,L as N,u as I,a as L,b as k,c as q,d as R,e as j}from"./CurrentUserStore-886fe293.js";import{r as f}from"./react-venders-3a9fd7ec.js";import{d as Q}from"./dataSources-efcbf825.js";import{A as F}from"./AuthTokensStore-9401662d.js";import{R as M}from"./team-a9599a92.js";import{S as G}from"./paths-1d44e380.js";import{f as K}from"./formatTime-900939d2.js";import"./tslib.es6-5f87f175.js";import"./urql.es-e4ed66a8.js";import"./index-801816c4.js";const P="Default team",x=t=>t==null?void 0:t.map(a=>{var i,p,n,s,r,o,d,_,c,l,u,y;return{id:a==null?void 0:a.id,user_id:a==null?void 0:a.user_id,email:(p=(i=a==null?void 0:a.user)==null?void 0:i.account)==null?void 0:p.email,avatarUrl:a.user.avatar_url,displayName:a.user.display_name,accessList:(s=(n=a.member_roles)==null?void 0:n[0])==null?void 0:s.access_list,role:{id:(o=(r=a.member_roles)==null?void 0:r[0])==null?void 0:o.id,name:(_=(d=a.member_roles)==null?void 0:d[0])==null?void 0:_.team_role},createdAt:((l=(c=a.member_roles)==null?void 0:c[0])==null?void 0:l.created_at)||a.created_at,updatedAt:((y=(u=a.member_roles)==null?void 0:u[0])==null?void 0:y.updated_at)||a.updated_at}}),C=t=>t!=null&&t.length?t.map(e=>({id:e==null?void 0:e.id,name:e.name,dbParams:e.db_params_computed,createdAt:e.created_at,updatedAt:e.updated_at,type:Q.find(a=>a.value===e.db_type.toLowerCase()),branches:e.branches})):[],T=t=>t!=null&&t.length?t.map(e=>{var a;return{id:e.id,name:e.name,type:e.delivery_type,schedule:e.schedule,creator:{displayName:e.user.display_name,avatarUrl:e.user.avatar_url,email:(a=e.user.account)==null?void 0:a.email},exploration:e.exploration,updatedAt:e.updated_at,createdAt:e.created_at,triggerConfig:e.trigger_config,deliveryConfig:e.delivery_config}}):[],Y=t=>t!=null&&t.length?t.map(e=>{var a;return{id:e.id,name:e.name,type:e.delivery_type,schedule:e.schedule,creator:{displayName:e.user.display_name,avatarUrl:e.user.avatar_url,email:(a=e.user.account)==null?void 0:a.email},exploration:e.exploration,updatedAt:e.updated_at,createdAt:e.created_at,deliveryConfig:e.delivery_config}}):[],z=t=>{var i,p;const e=t.users_by_pk||null,a=((i=e==null?void 0:e.members)==null?void 0:i.reduce((n,s)=>{var _,c,l,u;const r=x((_=s==null?void 0:s.team)==null?void 0:_.members),o=(c=r.find(y=>y.role.name===M.owner))==null?void 0:c.email,d={...s.team,creatorEmail:o,role:(u=(l=s==null?void 0:s.member_roles)==null?void 0:l[0])==null?void 0:u.team_role,updatedAt:s.team.updated_at,createdAt:s.team.created_at,members:r};return delete d.created_at,delete d.updated_at,n.push(d),n},[]))||[];return{id:e==null?void 0:e.id,email:(p=e==null?void 0:e.account)==null?void 0:p.email,displayName:e==null?void 0:e.display_name,avatarUrl:e==null?void 0:e.avatar_url,teams:(a||[]).sort((n,s)=>Date.parse(n.updatedAt)-Date.parse(s.updatedAt))}},B=t=>t!=null&&t.length?t.reduce((e,a)=>{var n;const i=(n=C([a]))==null?void 0:n[0],p=((a==null?void 0:a.sql_credentials)||[]).map(s=>{var r,o;return{id:s.id,login:s.username,createdAt:K(s.created_at),member:{userId:(r=s==null?void 0:s.user)==null?void 0:r.id,displayName:(o=s.user)==null?void 0:o.display_name},dataSourceData:i}});return[...e,...p]},[]):[],H=t=>{const e=t.teams_by_pk||null,a=C(e==null?void 0:e.datasources),i=T(e==null?void 0:e.alerts),p=Y(e==null?void 0:e.reports),n=x(e==null?void 0:e.members),s=B(e==null?void 0:e.datasources);return{dataSources:(a||[]).sort((r,o)=>Date.parse(o.updatedAt)-Date.parse(r.updatedAt)),alerts:i,reports:p,members:(n||[]).sort((r,o)=>Date.parse(o.updatedAt)-Date.parse(r.updatedAt)),sqlCredentials:(s||[]).sort((r,o)=>Date.parse(o.createdAt)-Date.parse(r.createdAt))}},O=()=>{var h;const{currentUser:t,currentTeam:e,setCurrentTeam:a,setLoading:i,setUserData:p,setTeamData:n}=D(),{JWTpayload:s,accessToken:r}=F(),o=s==null?void 0:s["x-hasura-user-id"],d=localStorage.getItem(N),[,_]=I(),[c,l]=L({variables:{id:o},pause:!0}),[u,y]=k({variables:{id:o},pause:!0}),[b,g]=q({variables:{team_id:e==null?void 0:e.id},pause:!0}),[A,E]=R({variables:{team_id:e==null?void 0:e.id},pause:!0});j(()=>{r&&o&&(l(),y(),e!=null&&e.id&&(g(),E())),r||(window.location.href=G)},[r,o,e==null?void 0:e.id]),f.useEffect(()=>{if(b.data){const m=H(b.data);n(m),i(!1)}},[n,i,b.data]),f.useEffect(()=>{A!=null&&A.data&&g()},[g,i,A==null?void 0:A.data]),f.useEffect(()=>{if(c.data){const m=z(c.data);p(m),i(!1)}},[c,i,p]),f.useEffect(()=>{u!=null&&u.data&&l()},[l,i,u==null?void 0:u.data]);const v=f.useCallback(async()=>{await _({name:P}),l()},[_,l]);return f.useEffect(()=>{var m;t!=null&&t.id&&!((m=t==null?void 0:t.teams)!=null&&m.length)&&v()},[t==null?void 0:t.id,(h=t==null?void 0:t.teams)==null?void 0:h.length,v]),f.useEffect(()=>{var m;(m=t==null?void 0:t.teams)!=null&&m.length&&a(d||t.teams[0].id)},[e,t.teams,d,a]),{currentUser:t,queries:{currentUserData:c,execQueryCurrentUser:l}}},se=({children:t})=>(O(),S.jsx(S.Fragment,{children:t}));export{se as default};
