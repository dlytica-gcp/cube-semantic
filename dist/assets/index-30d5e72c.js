import{S as I,u as z,F as $,I as b}from"./index-f28b3217.js";import{j as t,c as g,S as E}from"./index-31f541c4.js";import{T as F}from"./index-19cf5167.js";import{A as U}from"./index-74275833.js";import{f as T}from"./formatTime-900939d2.js";import{u as w}from"./useTranslation-f1e31b7f.js";import{a as M,e as k,s as h,A as V}from"./index-c0d2be16.js";import{r as q}from"./react-venders-3a9fd7ec.js";import{N as O,P as G,C as K}from"./CurrentUserStore-886fe293.js";import{u as W}from"./useTableState-787b51cf.js";import{u as Y}from"./useLocation-795e9ebc.js";import{R as B,C as p}from"./index-2a334e56.js";import{Q as H}from"./paths-1d44e380.js";import"./button-255d95e9.js";import"./dayjs.min-e1e47a26.js";import"./index-166ce56c.js";import"./index-d72c3122.js";import"./tslib.es6-5f87f175.js";import"./alertTypes-bd9943c7.js";import"./Sider-2eea88ce.js";import"./index-17f232aa.js";import"./index-d4c68e4d.js";import"./validations-55614028.js";import"./capitalize-b2c18dd5.js";import"./useCheckResponse-471c00b7.js";import"./index-4e5c896b.js";import"./index-217cb9e2.js";import"./AuthTokensStore-9401662d.js";import"./index-801816c4.js";import"./genName-6cc4e155.js";import"./index-03282bf3.js";import"./index-e26e008e.js";import"./index-74b97788.js";import"./trash-colored-debd1411.js";import"./team-a9599a92.js";import"./urql.es-e4ed66a8.js";const J="_table_1klo8_1",X="_headerRight_1klo8_7",Z="_cell_1klo8_11",D="_dataSource_1klo8_15",ee="_startTime_1klo8_19",te="_createdAt_1klo8_20",l={table:J,headerRight:X,cell:Z,dataSource:D,startTime:ee,createdAt:te},ae=({logs:o,onChange:e,onClickRow:s,dataSources:_,members:d,pagination:n=!1})=>{const{t:i}=w(["logs"]),m=[{title:i("query.table.data_source"),dataIndex:"datasource_id",key:"datasource_id",render:a=>{var r;return t.jsx("span",{className:g(l.cell,l.dataSource),children:((r=_.find(c=>c.id===a))==null?void 0:r.name)||a})}},{title:i("query.table.path"),dataIndex:"path",key:"path",render:a=>t.jsx("span",{className:g(l.cell,l.path),children:a})},{title:i("query.table.events"),dataIndex:"request_event_logs_aggregate",key:"request_event_logs_aggregate",render:a=>{var r;return t.jsx("span",{className:g(l.cell,l.events),children:(r=a==null?void 0:a.aggregate)==null?void 0:r.count})}},{title:i("query.table.creator"),dataIndex:"user_id",key:"user_id",render:a=>{const r=d.find(c=>c.user_id===a);return r?t.jsx("span",{className:g(l.cell,l.creator),children:t.jsxs(I,{size:10,children:[t.jsx(U,{img:r==null?void 0:r.avatarUrl,username:r==null?void 0:r.displayName}),t.jsx("span",{children:r==null?void 0:r.displayName})]})}):t.jsx("span",{className:g(l.cell,l.creator),children:t.jsx("span",{children:a})})}},{title:i("query.table.duration"),dataIndex:"duration",key:"duration",render:a=>t.jsxs("span",{className:g(l.cell,l.duration),children:[a," ",i("query.table.ms")]})},{title:t.jsx("div",{className:l.headerRight,children:i("query.table.start_time")}),dataIndex:"start_time",key:"start_time",render:a=>t.jsx("span",{className:g(l.cell,l.startTime,l.headerRight),children:T(a)})},{title:t.jsx("div",{className:l.headerRight,children:i("query.table.created_at")}),dataIndex:"created_at",key:"created_at",render:a=>t.jsx("span",{className:g(l.cell,l.createdAt,l.headerRight),children:T(a)})}];return t.jsx(F,{className:l.table,columns:m,dataSource:o,rowKey:a=>a.id,onRow:a=>({onClick:()=>s==null?void 0:s(a.id),style:{cursor:"pointer"}}),pagination:n,onChange:e})},L=(o,e={})=>{let s={};return o&&(s={...s,...o}),e!=null&&e.from&&(s=h("where.created_at._gte",e.from,s)),e!=null&&e.to&&(s=h("where.created_at._lte",e.to,s)),e!=null&&e.dataSourceId&&(s=h("where.datasource_id._eq",e.dataSourceId,s)),e!=null&&e.sort&&(s=h("order_by.duration",e.sort,s)),e!=null&&e.teamId&&(s=h("where.datasource.team_id._eq",e.teamId,s)),o&&!e.sort&&(s=h("order_by.created_at","desc",s)),s},se=(o,e)=>e,re=({pauseQueryAll:o=!1,pagination:e={},params:s={}})=>{const[_,d]=O({variables:L(e,s),pause:o},se),[n,i]=G({variables:L(e,s),pause:o,requestPolicy:"cache-and-network"});M((r,c,u)=>{if(!k(c==null?void 0:c[0],u==null?void 0:u[0])){const f=c==null?void 0:c[1],y=u==null?void 0:u[1];let x=!1;!f||!y?x=!1:x=!k(f,y),x&&i({requestPolicy:"network-only"})}},[e,_.data,i]);const m=q.useMemo(()=>{var r;return((r=n.data)==null?void 0:r.request_logs)||[]},[n.data]),a=q.useMemo(()=>{var r,c,u;return((u=(c=(r=n.data)==null?void 0:r.request_logs_aggregate)==null?void 0:c.aggregate)==null?void 0:u.count)||0},[n.data]);return{allLogs:m,totalCount:a,queries:{allData:n,execQueryAll:i},subscriptions:{subscription:_,execSubscription:d}}},oe="_input_v8xm1_1",j={input:oe},le=({dataSources:o,onChange:e,defaultValues:s={dataSourceId:null,from:null,to:null,sort:null},values:_})=>{const{t:d}=w(["logs"]),{control:n,watch:i}=z({defaultValues:s,values:_});return q.useEffect(()=>{const m=i(a=>e(a));return()=>m.unsubscribe()},[e,i]),t.jsx($,{layout:"vertical",children:t.jsxs(B,{gutter:[10,0],children:[t.jsx(p,{xs:24,md:12,lg:6,xl:4,children:t.jsx(b,{className:j.input,control:n,name:"dataSourceId",placeholder:d("query.filter.select"),label:d("query.filter.data_source"),fieldType:"select",allowClear:!0,options:o==null?void 0:o.map(m=>({value:m.id||"",label:m.name}))})}),t.jsx(p,{xs:24,md:12,lg:6,xl:4,children:t.jsx(b,{className:j.input,control:n,name:"from",fieldType:"date",label:d("query.filter.from"),showTime:!0})}),t.jsx(p,{xs:24,md:12,lg:6,xl:4,children:t.jsx(b,{className:j.input,control:n,name:"to",fieldType:"date",label:d("query.filter.to"),showTime:!0})}),t.jsx(p,{xs:24,md:12,lg:6,xl:4,children:t.jsx(b,{className:j.input,control:n,name:"sort",label:d("query.filter.sort"),fieldType:"select",defaultValue:"asc",allowClear:!0,options:[{value:"asc",label:"Asc"},{value:"desc",label:"Desc"}]})})]})})},ie="_wrapper_1g1td_1",ne="_space_1g1td_4",ce="_body_1g1td_7",de="_action_1g1td_10",ue="_actionIcon_1g1td_14",N={wrapper:ie,space:ne,body:ce,action:de,actionIcon:ue},me=({logs:o=[],logsCount:e=0,currentPage:s,pageSize:_=1,fetching:d=!1,dataSources:n,filter:i,members:m,onFilterUpdate:a=()=>{},onPageChange:r=()=>{},onClickRow:c=()=>{}})=>{const{t:u}=w(["logs","pages","common"]);return t.jsx(V,{divider:!0,title:u("pages:logs.query"),children:t.jsx(I,{className:N.wrapper,direction:"vertical",size:13,children:t.jsx("div",{className:N.body,children:t.jsxs(I,{size:27,className:N.space,direction:"vertical",children:[t.jsx(le,{values:i,dataSources:n,onChange:a}),t.jsx(E,{spinning:d,children:t.jsx(ae,{logs:o,onClickRow:c,members:m,dataSources:n,pagination:{pageSize:_,current:s,total:e,onChange:f=>r({current:f}),showSizeChanger:!1}})})]})})})})},He=()=>{const{teamData:o,currentTeam:e}=K(),[s,_]=Y(),d=H,{dataSourceId:n=null,from:i=null,to:m=null,sort:a=null}=s.query,r={dataSourceId:n,from:i,to:m,sort:a},c=q.useMemo(()=>(o==null?void 0:o.dataSources)||[],[o]),{tableState:{pageSize:u,currentPage:f,paginationVars:y},onPageChange:x}=W({customPageSize:10}),{allLogs:A,totalCount:C,queries:{allData:R}}=re({pagination:y,params:{teamId:e==null?void 0:e.id,...r}}),P=S=>_(`${d}/${S}`),Q=S=>{_(`${d}?${new URLSearchParams(Object.entries(S).filter(v=>v[1]))}`)};return t.jsx(me,{logs:A,logsCount:C,currentPage:f,pageSize:u,fetching:R.fetching,dataSources:c,members:(o==null?void 0:o.members)||[],filter:r,onFilterUpdate:Q,onPageChange:x,onClickRow:P})};export{me as QueryLogs,He as default};
